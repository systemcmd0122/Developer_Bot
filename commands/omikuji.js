// commands/fortune.js
const { SlashCommandBuilder, EmbedBuilder } = require('discord.js');
const { v4: uuidv4 } = require('uuid');
const path = require('path');
const fs = require('fs');

module.exports = {
    category: 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ¡ãƒ³ãƒˆ',
    data: new SlashCommandBuilder()
        .setName('fortune')
        .setDescription('ä»Šæ—¥ã®é‹å‹¢ã‚’å ã„ã¾ã™')
        .addStringOption(option =>
            option.setName('type')
                .setDescription('ãŠã¿ãã˜ã®ç¨®é¡')
                .setRequired(false)
                .addChoices(
                    { name: 'é€šå¸¸ãŠã¿ãã˜', value: 'normal' },
                    { name: 'æ‹æ„›ãŠã¿ãã˜', value: 'love' },
                    { name: 'ã‚²ãƒ¼ãƒãƒ¼ãŠã¿ãã˜', value: 'gamer' },
                    { name: 'ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ãŠã¿ãã˜', value: 'programmer' }
                )
        ),
    async execute(interaction) {
        await interaction.deferReply();

        const userId = interaction.user.id;
        const username = interaction.user.username;
        const type = interaction.options.getString('type') || 'normal';
        
        // ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚·ãƒ¼ãƒ‰å€¤ã¨ã—ã¦ä½¿ç”¨
        const today = new Date();
        const dateString = `${today.getFullYear()}${today.getMonth()}${today.getDate()}`;
        const seed = parseInt(dateString + userId);
        
        // ã‚·ãƒ¼ãƒ‰å€¤ã‹ã‚‰é‹å‹¢ã‚’æ±ºå®š
        const fortune = getFortuneResult(seed, type);
        
        // çµæœã‚’JSONã«ä¿å­˜
        saveFortuneHistory(userId, username, fortune, type);
        
        // é‹å‹¢ã«å¿œã˜ãŸè‰²ã‚’è¨­å®š
        const colors = {
            'å¤§å‰': '#FF0000',
            'ä¸­å‰': '#FFA500',
            'å°å‰': '#FFFF00',
            'å‰': '#00FF00',
            'æœ«å‰': '#00FFFF',
            'å‡¶': '#0000FF',
            'å¤§å‡¶': '#800080'
        };
        
        // é‹å‹¢ã«å¿œã˜ãŸçµµæ–‡å­—ã‚’è¨­å®š
        const emojis = {
            'å¤§å‰': 'ğŸŒŸ',
            'ä¸­å‰': 'âœ¨',
            'å°å‰': 'ğŸ€',
            'å‰': 'ğŸ˜Š',
            'æœ«å‰': 'ğŸ¤”',
            'å‡¶': 'â˜ï¸',
            'å¤§å‡¶': 'âš¡'
        };
        
        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã®ãŸã‚ã®é…å»¶
        setTimeout(async () => {
            // ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—
            const advice = getRandomAdvice(type);
            
            // é‹å‹¢ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ä½œæˆ
            const embed = new EmbedBuilder()
                .setTitle(`${emojis[fortune.luck]} ${username}ã•ã‚“ã®${getTypeName(type)}çµæœ ${emojis[fortune.luck]}`)
                .setDescription(`**${fortune.luck}**`)
                .setColor(colors[fortune.luck])
                .addFields(
                    { name: 'ğŸ’« ä»Šæ—¥ã®ãƒ©ãƒƒã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆ', value: fortune.luckyPoint, inline: false },
                    { name: 'ğŸ”® ã‚¢ãƒ‰ãƒã‚¤ã‚¹', value: advice, inline: false },
                    { name: 'ğŸ² ãƒ©ãƒƒã‚­ãƒ¼ãƒŠãƒ³ãƒãƒ¼', value: `${Math.floor(seed % 100)}`, inline: true },
                    { name: 'ğŸŒˆ ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼', value: fortune.luckyColor, inline: true }
                )
                .setFooter({ 
                    text: `ID: ${uuidv4().substring(0, 8)} â€¢ ${today.toLocaleDateString('ja-JP')}ã®ãŠã¿ãã˜`,
                })
                .setTimestamp();
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é‹å‹¢ã«åŸºã¥ã„ã¦ç‰¹åˆ¥ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¿½åŠ 
            if (fortune.luck === 'å¤§å‰') {
                embed.addFields({ name: 'ğŸ‰ ç‰¹åˆ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸', value: 'ç´ æ™´ã‚‰ã—ã„1æ—¥ã«ãªã‚‹ã§ã—ã‚‡ã†ï¼ä½•äº‹ã‚‚ã†ã¾ãã„ãã¾ã™ï¼', inline: false });
            } else if (fortune.luck === 'å¤§å‡¶') {
                embed.addFields({ name: 'âš ï¸ æ³¨æ„', value: 'ä»Šæ—¥ã¯æ…é‡ã«è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚æ˜æ—¥ã¯ãã£ã¨è‰¯ã„æ—¥ã«ãªã‚Šã¾ã™ï¼', inline: false });
                
                // å¤§å‡¶ã®å ´åˆã¯å›é¿æ–¹æ³•ã‚‚ææ¡ˆ
                embed.addFields({ name: 'ğŸ›¡ï¸ å‡¶ã‚’å›é¿ã™ã‚‹æ–¹æ³•', value: getAvoidanceTip(), inline: false });
            }
            
            // ç‰¹æ®ŠåŠ¹æœï¼ˆã‚¿ã‚¤ãƒ—ã«å¿œã˜ãŸè¿½åŠ æƒ…å ±ï¼‰
            if (type === 'programmer') {
                embed.addFields({ name: 'ğŸ’» ä»Šæ—¥ã®ãƒã‚°ç™ºç”Ÿç¢ºç‡', value: `${Math.floor((seed % 30) + 5)}%`, inline: true });
                embed.addFields({ name: 'âŒ¨ï¸ ãŠã™ã™ã‚è¨€èª', value: getRandomProgrammingLanguage(seed), inline: true });
            } else if (type === 'gamer') {
                embed.addFields({ name: 'ğŸ® ãƒ—ãƒ¬ã‚¤ã™ã¹ãã‚²ãƒ¼ãƒ ã‚¸ãƒ£ãƒ³ãƒ«', value: getRandomGameGenre(seed), inline: true });
                embed.addFields({ name: 'ğŸ† ä»Šæ—¥ã®å‹ç‡', value: `${Math.floor((seed % 50) + 50)}%`, inline: true });
            } else if (type === 'love') {
                embed.addFields({ name: 'ğŸ’• é‹å‘½ã®å‡ºä¼šã„ã®å ´æ‰€', value: getRandomMeetingPlace(seed), inline: true });
                embed.addFields({ name: 'ğŸ’Œ å¥½å°è±¡ã‚’ä¸ãˆã‚‹ã‚¢ãƒ—ãƒ­ãƒ¼ãƒ', value: getRandomApproach(seed), inline: true });
            }
            
            // çµæœã‚’è¡¨ç¤º
            await interaction.editReply({ embeds: [embed] });
            
            // å¤§å‰ã‚„å¤§å‡¶ã®å ´åˆã¯è¿½åŠ åå¿œ
            if (fortune.luck === 'å¤§å‰' || fortune.luck === 'å¤§å‡¶') {
                setTimeout(() => {
                    interaction.followUp({
                        content: fortune.luck === 'å¤§å‰' 
                            ? `${interaction.user}ã•ã‚“ã€ç´ æ™´ã‚‰ã—ã„ï¼å¤§å‰ã§ã™ã‚ˆï¼ğŸ‰ğŸ‰ğŸ‰`
                            : `${interaction.user}ã•ã‚“ã€å¤§ä¸ˆå¤«ã§ã™ã€‚ã“ã‚Œã¯å˜ãªã‚‹å ã„ã§ã™ğŸ˜… æ°—ã«ã—ãªã„ã§ãã ã•ã„ï¼`,
                        ephemeral: false
                    });
                }, 1500);
            }
        }, 2000);
    },
};

// é‹å‹¢çµæœã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getFortuneResult(seed, type) {
    const random = mulberry32(seed);
    
    // é‹å‹¢ã®ç¢ºç‡: å¤§å‰(5%), ä¸­å‰(10%), å°å‰(20%), å‰(30%), æœ«å‰(20%), å‡¶(10%), å¤§å‡¶(5%)
    const luckRand = random();
    let luck;
    
    if (luckRand < 0.05) luck = 'å¤§å‰';
    else if (luckRand < 0.15) luck = 'ä¸­å‰';
    else if (luckRand < 0.35) luck = 'å°å‰';
    else if (luckRand < 0.65) luck = 'å‰';
    else if (luckRand < 0.85) luck = 'æœ«å‰';
    else if (luckRand < 0.95) luck = 'å‡¶';
    else luck = 'å¤§å‡¶';
    
    // ãƒ©ãƒƒã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã‚’å–å¾—
    const luckyPoints = {
        'normal': ['å®¶æ—ã¨ã®ä¼šè©±', 'æ–°ã—ã„æœ¬', 'æ•£æ­©', 'æœé£Ÿ', 'è‡ªç„¶', 'éŸ³æ¥½é‘‘è³', 'æƒé™¤', 'æ—©èµ·ã', 'æ¸©ã‹ã„é£²ã¿ç‰©', 'SNSã®ä¼‘æ†©'],
        'love': ['èª å®Ÿãªä¼šè©±', 'ã‚«ãƒ•ã‚§ã§ã®ãƒ‡ãƒ¼ãƒˆ', 'æ‰‹ç´™', 'æ€ã„å‡ºã®å ´æ‰€', 'ã‚µãƒ—ãƒ©ã‚¤ã‚ºãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆ', 'å…±é€šã®è¶£å‘³', 'æ–™ç†ä½œã‚Š', 'è‡ªç„¶ã®ä¸­ã§ã®ã‚“ã³ã‚Š', 'æ˜ ç”»é‘‘è³', 'ã‚¢ã‚¤ã‚³ãƒ³ã‚¿ã‚¯ãƒˆ'],
        'gamer': ['æ–°ä½œã‚²ãƒ¼ãƒ ', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³å¯¾æˆ¦', 'ãƒ¬ãƒˆãƒ­ã‚²ãƒ¼ãƒ ', 'ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãƒ¢ãƒ¼ãƒ‰', 'ã‚¢ãƒãƒ¼ãƒ–ãƒ¡ãƒ³ãƒˆé›†ã‚', 'ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨ã®ãƒ—ãƒ¬ã‚¤', 'ã‚²ãƒ¼ãƒ é…ä¿¡', 'ã‚²ãƒ¼ãƒ ã®æ”»ç•¥æœ¬', 'Eã‚¹ãƒãƒ¼ãƒ„è¦³æˆ¦', 'ã‚²ãƒ¼ãƒ BGM'],
        'programmer': ['æ–°è¨€èªã®å‹‰å¼·', 'ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°', 'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼', 'ã‚ªãƒ¼ãƒ—ãƒ³ã‚½ãƒ¼ã‚¹ã¸ã®è²¢çŒ®', 'ã‚¹ã‚¿ãƒƒã‚¯ãƒ»ã‚ªãƒ¼ãƒãƒ¼ãƒ•ãƒ­ãƒ¼ã§ã®å›ç­”', 'ãƒ†ã‚¹ãƒˆé§†å‹•é–‹ç™º', 'ãƒ‡ãƒãƒƒã‚°ã®é›†ä¸­æ™‚é–“', 'ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¦ç´„ã®è¦‹ç›´ã—', 'ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨ˆç”»', 'ã‚³ãƒ¼ãƒ‰ã®æœ€é©åŒ–']
    };
    
    const luckyPoint = luckyPoints[type][Math.floor(random() * luckyPoints[type].length)];
    
    // ãƒ©ãƒƒã‚­ãƒ¼ã‚«ãƒ©ãƒ¼ã‚’å–å¾—
    const colors = ['èµ¤', 'é’', 'é»„', 'ç·‘', 'ç´«', 'ã‚ªãƒ¬ãƒ³ã‚¸', 'ãƒ”ãƒ³ã‚¯', 'ç™½', 'é»’', 'æ°´è‰²', 'é‡‘', 'éŠ€', 'èŒ¶è‰²', 'ç°è‰²'];
    const luckyColor = colors[Math.floor(random() * colors.length)];
    
    return { luck, luckyPoint, luckyColor };
}

// ã‚·ãƒ¼ãƒ‰å€¤ã‹ã‚‰ç–‘ä¼¼ä¹±æ•°ã‚’ç”Ÿæˆã™ã‚‹é–¢æ•°ï¼ˆMulberry32ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼‰
function mulberry32(seed) {
    return function() {
        seed += 0x6D2B79F5;
        let t = seed;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t ^= t + Math.imul(t ^ t >>> 7, t | 61);
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
    };
}

// ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomAdvice(type) {
    const advices = {
        'normal': [
            'ä»Šæ—¥ã¯æ–°ã—ã„ã“ã¨ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'äººã¨ã®ç¹‹ãŒã‚Šã‚’å¤§åˆ‡ã«ã™ã‚‹ã¨è‰¯ã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚',
            'è‡ªåˆ†ã®æ™‚é–“ã‚’ä½œã‚‹ã“ã¨ã§å¿ƒãŒè½ã¡ç€ãã¾ã™ã€‚',
            'ç©æ¥µçš„ãªè¡Œå‹•ãŒå¹¸é‹ã‚’å¼•ãå¯„ã›ã‚‹ã§ã—ã‚‡ã†ã€‚',
            'å°ã•ãªå¹¸ã›ã«æ°—ã¥ãç›®ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚',
            'æ„Ÿè¬ã®æ°—æŒã¡ã‚’å¿˜ã‚Œãªã„ã§ã„ã‚‹ã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚',
            'ç„¦ã‚‰ãšç€å®Ÿã«é€²ã‚€ã“ã¨ã§è‰¯ã„çµæœãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚',
            'ç›´æ„Ÿã‚’ä¿¡ã˜ã¦è¡Œå‹•ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'å›°ã£ã¦ã„ã‚‹äººã‚’åŠ©ã‘ã‚‹ã¨è‰¯ã„ã“ã¨ãŒè¿”ã£ã¦ãã¾ã™ã€‚',
            'è‡ªåˆ†ã‚’ä¿¡ã˜ã‚‹æ°—æŒã¡ãŒæˆåŠŸã¸ã®éµã§ã™ã€‚'
        ],
        'love': [
            'è‡ªåˆ†ã‚‰ã—ã•ã‚’å¤§åˆ‡ã«ã™ã‚‹ã“ã¨ã§é­…åŠ›ãŒå¢—ã—ã¾ã™ã€‚',
            'ç›¸æ‰‹ã®è©±ã‚’ã—ã£ã‹ã‚Šèãã“ã¨ãŒå¤§åˆ‡ã§ã™ã€‚',
            'æ€ã„åˆ‡ã£ãŸå‘Šç™½ãŒå®Ÿã‚’çµã¶æ—¥ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',
            'å°ã•ãªæ°—é£ã„ãŒç›¸æ‰‹ã®å¿ƒã‚’å‹•ã‹ã—ã¾ã™ã€‚',
            'è‡ªç„¶ä½“ã§æ¥ã™ã‚‹ã“ã¨ãŒæœ€å¤§ã®æ­¦å™¨ã§ã™ã€‚',
            'å…±é€šã®è¶£å‘³ã‚’è¦‹ã¤ã‘ã‚‹ã¨ä»²ãŒæ·±ã¾ã‚Šã¾ã™ã€‚',
            'ç„¦ã‚‰ãšé–¢ä¿‚ã‚’è‚²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ã€‚',
            'æ€ã„ã‚„ã‚Šã®ã‚ã‚‹è¨€è‘‰ãŒã‚­ãƒ¼ãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚',
            'ç›¸æ‰‹ã®è‰¯ã„ã¨ã“ã‚ã‚’è¦‹ã¤ã‘ã‚‹ç›®ã‚’æŒã¡ã¾ã—ã‚‡ã†ã€‚',
            'ç¬‘é¡”ãŒæœ€é«˜ã®ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚'
        ],
        'gamer': [
            'ä»Šæ—¥ã¯æ–°ã—ã„ã‚²ãƒ¼ãƒ ã‚¸ãƒ£ãƒ³ãƒ«ã«æŒ‘æˆ¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'ãƒãƒ¼ãƒ ãƒ—ãƒ¬ã‚¤ã§æ€ã‚ã¬ç™ºè¦‹ãŒã‚ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',
            'æ”»ç•¥ã‚’è¦‹ãšã«è‡ªåˆ†ã®åŠ›ã§é€²ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'ã‚½ãƒ­ãƒ—ãƒ¬ã‚¤ã«é›†ä¸­ã™ã‚‹ã¨æ–°ãŸãªç™ºè¦‹ãŒã‚ã‚Šã¾ã™ã€‚',
            'ã‚²ãƒ¼ãƒ ã®è¨­å®šã‚„èƒŒæ™¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ã‚’æ¥½ã—ã‚€ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚',
            'å®šæœŸçš„ãªä¼‘æ†©ãŒé›†ä¸­åŠ›ã‚’é«˜ã‚ã¾ã™ã€‚',
            'é›£ã—ã„ãƒœã‚¹ã«ã¯æ–°ã—ã„æˆ¦ç•¥ã‚’è©¦ã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚',
            'ãƒ•ãƒ¬ãƒ³ãƒ‰ã¨æƒ…å ±äº¤æ›ã™ã‚‹ã¨æœ‰ç›Šãªæƒ…å ±ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚',
            'ã‚¹ãƒˆãƒ¬ã‚¹ã‚’æ„Ÿã˜ãŸã‚‰åˆ¥ã®ã‚²ãƒ¼ãƒ ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ã‚‡ã†ã€‚',
            'ã‚¹ã‚­ãƒ«ã‚ˆã‚Šã‚‚æ¥½ã—ã‚€ã“ã¨ã‚’å„ªå…ˆã—ã¾ã—ã‚‡ã†ã€‚'
        ],
        'programmer': [
            'ä»Šæ—¥ã¯ã‚³ãƒ¼ãƒ‰ã®æœ€é©åŒ–ã«å–ã‚Šçµ„ã‚€ã¨è‰¯ã„ç™ºè¦‹ãŒã‚ã‚Šã¾ã™ã€‚',
            'é›£ã—ã„å•é¡Œã¯ä¸€åº¦é›¢ã‚Œã¦ã¿ã‚‹ã¨è§£æ±ºç­–ãŒè¦‹ã¤ã‹ã‚‹ã§ã—ã‚‡ã†ã€‚',
            'ãƒšã‚¢ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã§åŠ¹ç‡ãŒä¸ŠãŒã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',
            'æ–°ã—ã„ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚„ãƒ•ãƒ¬ãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯ã‚’å­¦ã¶è‰¯ã„æ©Ÿä¼šã§ã™ã€‚',
            'ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆä½œæˆã«æ™‚é–“ã‚’ã‹ã‘ã‚‹ã¨å°†æ¥ã®è‡ªåˆ†ãŒå–œã³ã¾ã™ã€‚',
            'ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹ã‚’å¢—ã‚„ã™ã“ã¨ã§ãƒã‚°ãŒæ¸›å°‘ã™ã‚‹ã§ã—ã‚‡ã†ã€‚',
            'ã‚³ãƒ¼ãƒ‰ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ä¾é ¼ã™ã‚‹ã¨æ–°ãŸãªè¦–ç‚¹ãŒå¾—ã‚‰ã‚Œã¾ã™ã€‚',
            'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã«å‚åŠ ã™ã‚‹ã¨åˆºæ¿€ã‚’å—ã‘ã¾ã™ã€‚',
            'å¤ã„ã‚³ãƒ¼ãƒ‰ã‚’ãƒªãƒ•ã‚¡ã‚¯ã‚¿ãƒªãƒ³ã‚°ã™ã‚‹è‰¯ã„æ—¥ã§ã™ã€‚',
            'åŸºæœ¬ã«ç«‹ã¡è¿”ã‚‹ã“ã¨ã§æ–°ãŸãªç™ºè¦‹ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚'
        ]
    };
    
    const randomIndex = Math.floor(Math.random() * advices[type].length);
    return advices[type][randomIndex];
}

// å¤§å‡¶æ™‚ã®å›é¿æ–¹æ³•ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getAvoidanceTip() {
    const tips = [
        'æ·±å‘¼å¸ã‚’ã—ã¦ã€ãƒã‚¸ãƒ†ã‚£ãƒ–ãªè€ƒãˆã‚’å¿ƒãŒã‘ã¾ã—ã‚‡ã†ã€‚',
        'ä»Šæ—¥ã¯å¤§ããªæ±ºæ–­ã‚’é¿ã‘ã€æ…é‡ã«è¡Œå‹•ã—ã¾ã—ã‚‡ã†ã€‚',
        'æš—ã„è‰²ã®æœã‚’é¿ã‘ã€æ˜ã‚‹ã„è‰²ã‚’èº«ã«ã¤ã‘ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚',
        'èª°ã‹ã«è¦ªåˆ‡ã«ã™ã‚‹ã“ã¨ã§é‹æ°—ãŒä¸ŠãŒã‚Šã¾ã™ã€‚',
        'æ°´ã‚’ãŸãã•ã‚“é£²ã‚“ã§ã€æµ„åŒ–ã®åŠ›ã‚’å€Ÿã‚Šã¾ã—ã‚‡ã†ã€‚',
        'ä»Šæ—¥ã¯æ—©ã‚ã«ä¼‘ã‚“ã§ã€æ˜æ—¥ã«å‚™ãˆã¾ã—ã‚‡ã†ã€‚',
        'ç¬‘é¡”ã‚’å¿ƒãŒã‘ã‚‹ã¨ä¸é‹ã‚’é ã–ã‘ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚',
        'å°ã•ãªå¹¸ã›ã«æ„Ÿè¬ã™ã‚‹æ°—æŒã¡ãŒé‹æ°—ã‚’ä¸Šã’ã¾ã™ã€‚',
        'è‡ªåˆ†ã®å¥½ããªéŸ³æ¥½ã‚’è´ã„ã¦ã€å¿ƒã‚’è½ã¡ç€ã‘ã¾ã—ã‚‡ã†ã€‚',
        'ä¿¡é ¼ã§ãã‚‹å‹äººã¨éã”ã™ã¨é‹æ°—ãŒä¸ŠãŒã‚Šã¾ã™ã€‚'
    ];
    
    return tips[Math.floor(Math.random() * tips.length)];
}

// ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomProgrammingLanguage(seed) {
    const languages = [
        'JavaScript', 'Python', 'Java', 'C#', 'TypeScript', 'Ruby', 'Go', 'Swift', 'Kotlin', 'Rust',
        'PHP', 'C++', 'Dart', 'Scala', 'Haskell', 'Elixir', 'Clojure', 'F#', 'COBOL', 'Assembly'
    ];
    
    return languages[seed % languages.length];
}

// ãƒ©ãƒ³ãƒ€ãƒ ãªã‚²ãƒ¼ãƒ ã‚¸ãƒ£ãƒ³ãƒ«ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomGameGenre(seed) {
    const genres = [
        'RPG', 'FPS', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ‘ã‚ºãƒ«', 'ãƒ¬ãƒ¼ã‚·ãƒ³ã‚°',
        'ã‚¹ãƒãƒ¼ãƒ„', 'ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ãƒ¼', 'MMORPG', 'MOBA', 'ãƒ›ãƒ©ãƒ¼', 'ã‚ªãƒ¼ãƒ—ãƒ³ãƒ¯ãƒ¼ãƒ«ãƒ‰', 'ãƒªã‚ºãƒ ã‚²ãƒ¼ãƒ ',
        'ãƒ•ã‚¡ã‚¤ãƒ†ã‚£ãƒ³ã‚°', 'ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹', 'ãƒ­ãƒ¼ã‚°ãƒ©ã‚¤ã‚¯', 'ã‚«ãƒ¼ãƒ‰ã‚²ãƒ¼ãƒ ', 'ã‚¿ãƒ¯ãƒ¼ãƒ‡ã‚£ãƒ•ã‚§ãƒ³ã‚¹', 'ãƒãƒˆãƒ«ãƒ­ã‚¤ãƒ¤ãƒ«'
    ];
    
    return genres[seed % genres.length];
}

// ãƒ©ãƒ³ãƒ€ãƒ ãªå‡ºä¼šã„ã®å ´æ‰€ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomMeetingPlace(seed) {
    const places = [
        'ã‚«ãƒ•ã‚§', 'æ›¸åº—', 'å…¬åœ’', 'ç¾è¡“é¤¨', 'æ˜ ç”»é¤¨', 'ã‚³ãƒ³ã‚µãƒ¼ãƒˆ', 'ã‚¹ãƒãƒ¼ãƒ„ã‚¸ãƒ ', 'æ–™ç†æ•™å®¤',
        'èªå­¦æ•™å®¤', 'å‹äººã®ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼', 'è·å ´', 'é›»è»Š', 'é€šå‹¤è·¯', 'SNS', 'ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã‚²ãƒ¼ãƒ ',
        'è¶£å‘³ã®ã‚µãƒ¼ã‚¯ãƒ«', 'ãƒœãƒ©ãƒ³ãƒ†ã‚£ã‚¢æ´»å‹•', 'æ—…è¡Œå…ˆ', 'ã‚·ãƒ§ãƒƒãƒ”ãƒ³ã‚°ãƒ¢ãƒ¼ãƒ«', 'ãƒšãƒƒãƒˆã‚·ãƒ§ãƒƒãƒ—'
    ];
    
    return places[seed % places.length];
}

// ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒæ–¹æ³•ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getRandomApproach(seed) {
    const approaches = [
        'å…±é€šã®è©±é¡Œã§ä¼šè©±ã‚’å§‹ã‚ã‚‹', 'è‡ªç„¶ãªç¬‘é¡”ã§æ¥ã™ã‚‹', 'ç›¸æ‰‹ã®è©±ã«èˆˆå‘³ã‚’æŒã£ã¦èã',
        'å°ã•ãªè¦ªåˆ‡ã‚’å¿ƒãŒã‘ã‚‹', 'å…±é€šã®è¶£å‘³ã®èª˜ã„ã‚’ã™ã‚‹', 'ç´ ç›´ãªæ°—æŒã¡ã‚’ä¼ãˆã‚‹',
        'ã‚°ãƒ«ãƒ¼ãƒ—æ´»å‹•ã«èª˜ã£ã¦ã¿ã‚‹', 'ãƒ¦ãƒ¼ãƒ¢ã‚¢ã‚’äº¤ãˆãŸä¼šè©±ã‚’ã™ã‚‹', 'ç›¸æ‰‹ã®è‰¯ã„ã¨ã“ã‚ã‚’è¤’ã‚ã‚‹',
        'å¶ç„¶ã‚’è£…ã£ãŸå†ä¼šã‚’æ¼”å‡ºã™ã‚‹', 'å‹äººã‚’ä»‹ã—ã¦çŸ¥ã‚Šåˆã†', 'è¶£å‘³ã®è©±ã‹ã‚‰å§‹ã‚ã‚‹',
        'SNSã§ã¤ãªãŒã‚Šã‚’æŒã¤', 'æ‰‹ä½œã‚Šã®ã‚‚ã®ã‚’ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã™ã‚‹', 'å›°ã£ã¦ã„ã‚‹ã¨ãã«åŠ©ã‘ã‚‹',
        'ç›¸æ‰‹ã®å¥½ããªã‚‚ã®ã«ã¤ã„ã¦è³ªå•ã™ã‚‹', 'ç‰¹åˆ¥ãªã‚¤ãƒ™ãƒ³ãƒˆã«èª˜ã†', 'è‡ªåˆ†ã®å¾—æ„ãªã“ã¨ã‚’æ•™ãˆã‚‹',
        'ç›¸æ‰‹ã®ãƒšãƒ¼ã‚¹ã«åˆã‚ã›ã‚‹', 'è‡ªåˆ†ã‚‰ã—ã•ã‚’å¤§åˆ‡ã«ã—ãªãŒã‚‰æ¥ã™ã‚‹'
    ];
    
    return approaches[seed % approaches.length];
}

// ãŠã¿ãã˜ã®ç¨®é¡ã®åå‰ã‚’å–å¾—ã™ã‚‹é–¢æ•°
function getTypeName(type) {
    const typeNames = {
        'normal': 'ãŠã¿ãã˜',
        'love': 'æ‹æ„›ãŠã¿ãã˜',
        'gamer': 'ã‚²ãƒ¼ãƒãƒ¼ãŠã¿ãã˜',
        'programmer': 'ãƒ—ãƒ­ã‚°ãƒ©ãƒãƒ¼ãŠã¿ãã˜'
    };
    
    return typeNames[type];
}

// ãŠã¿ãã˜ã®çµæœã‚’å±¥æ­´ã¨ã—ã¦ä¿å­˜ã™ã‚‹é–¢æ•°
function saveFortuneHistory(userId, username, fortune, type) {
    try {
        const dataDir = path.join(__dirname, '..', 'data');
        const filePath = path.join(dataDir, 'fortune_history.json');
        
        // ãƒ‡ãƒ¼ã‚¿ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ä½œæˆ
        if (!fs.existsSync(dataDir)) {
            fs.mkdirSync(dataDir, { recursive: true });
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯æ–°è¦ä½œæˆ
        let historyData = { users: {} };
        if (fs.existsSync(filePath)) {
            const fileContent = fs.readFileSync(filePath, 'utf8');
            if (fileContent.trim() !== '') {
                historyData = JSON.parse(fileContent);
            }
        }
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯åˆæœŸåŒ–
        if (!historyData.users[userId]) {
            historyData.users[userId] = {
                username: username,
                history: []
            };
        }
        
        // ä»Šæ—¥ã®æ—¥ä»˜
        const today = new Date().toISOString().split('T')[0];
        
        // å±¥æ­´ã«è¿½åŠ 
        historyData.users[userId].history.push({
            date: today,
            type: type,
            result: fortune.luck,
            luckyPoint: fortune.luckyPoint,
            luckyColor: fortune.luckyColor
        });
        
        // å±¥æ­´ã¯æœ€å¤§10ä»¶ã¾ã§ä¿å­˜
        if (historyData.users[userId].history.length > 10) {
            historyData.users[userId].history.shift();
        }
        
        // ãƒ•ã‚¡ã‚¤ãƒ«ã«ä¿å­˜
        fs.writeFileSync(filePath, JSON.stringify(historyData, null, 2), 'utf8');
        
    } catch (error) {
        console.error('Error saving fortune history:', error);
    }
}