<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Discord Bot Status Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        'discord-dark': '#2C2F33',
                        'discord-darker': '#23272A',
                        'discord-blurple': '#5865F2',
                        'discord-green': '#57F287',
                        'discord-yellow': '#FEE75C',
                        'discord-red': '#ED4245'
                    },
                    animation: {
                        'pulse-slow': 'pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease;
        }

        .dark {
            background-color: #2C2F33;
            color: #ffffff;
        }

        .theme-transition {
            transition: all 0.3s ease;
        }

        .card {
            backdrop-filter: blur(10px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        }

        .glassmorphism {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .command-list {
            max-height: 400px;
            overflow-y: auto;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }

        .command-list::-webkit-scrollbar {
            width: 6px;
        }

        .command-list::-webkit-scrollbar-track {
            background: transparent;
        }

        .command-list::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .notification {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-left-color: #5865F2;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ダークモード用のスタイル */
        .dark .card {
            background-color: rgba(35, 39, 42, 0.8);
        }

        .dark .text-primary {
            color: #ffffff;
        }

        .dark .bg-secondary {
            background-color: #2C2F33;
        }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen flex flex-col">
    <!-- Navigation -->
    <nav class="bg-discord-dark shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <span class="text-2xl font-bold text-discord-blurple flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 mr-2" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.644 12.644 0 0 0-.61-1.25.077.077 0 0 0-.079-.037 19.736 19.736 0 0 0-4.885 1.515.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994.021-.041.001-.088-.041-.104a13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.105c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
                            </svg>
                            Bot Dashboard
                        </span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div id="status-indicator" class="flex items-center space-x-2">
                        <div class="relative flex h-4 w-4">
                            <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-green-400 opacity-75"></span>
                            <span class="relative inline-flex rounded-full h-4 w-4 bg-green-500"></span>
                        </div>
                        <span class="text-green-400 font-medium">オンライン</span>
                    </div>
                    <button id="theme-toggle" class="p-2 rounded-lg bg-gray-700 hover:bg-gray-600 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8 space-y-8">
        <!-- Quick Stats Grid -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <h3 class="text-sm font-semibold text-gray-400 mb-2">総サーバー数</h3>
                <p class="text-2xl font-bold text-white" id="total-servers">0</p>
                <div class="mt-2 flex items-center text-sm">
                    <span class="text-green-400">↑ 2.5%</span>
                    <span class="text-gray-400 ml-2">過去7日間</span>
                </div>
            </div>
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <h3 class="text-sm font-semibold text-gray-400 mb-2">総ユーザー数</h3>
                <p class="text-2xl font-bold text-white" id="total-users">0</p>
                <div class="mt-2 flex items-center text-sm">
                    <span class="text-green-400">↑ 4.3%</span>
                    <span class="text-gray-400 ml-2">過去7日間</span>
                </div>
            </div>
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <h3 class="text-sm font-semibold text-gray-400 mb-2">コマンド実行回数</h3>
                <p class="text-2xl font-bold text-white" id="total-commands">0</p>
                <div class="mt-2 flex items-center text-sm">
                    <span class="text-green-400">↑ 1.8%</span>
                    <span class="text-gray-400 ml-2">過去24時間</span>
                </div>
            </div>
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <h3 class="text-sm font-semibold text-gray-400 mb-2">稼働時間</h3>
                <p class="text-2xl font-bold text-white" id="uptime">0d 0h 0m</p>
                <div class="mt-2 flex items-center text-sm">
                    <span class="text-green-400">99.9%</span>
                    <span class="text-gray-400 ml-2">可用性</span>
                </div>
            </div>
        </div>

        <!-- System Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- System Information Card -->
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-discord-blurple">システム情報</h3>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
                    </svg>
                </div>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-sm text-gray-400 mb-1">
                            <span>CPU使用率</span>
                            <span id="cpu-usage">0%</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="cpu-bar" class="bg-blue-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between text-sm text-gray-400 mb-1">
                            <span>メモリ使用率</span>
                            <span id="memory-usage">0 MB</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div id="memory-bar" class="bg-purple-600 h-2.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="bg-discord-darker rounded-lg p-3">
                            <h4 class="text-sm text-gray-400">Node.js バージョン</h4>
                            <p id="nodejs-version" class="text-lg font-semibold">-</p>
                        </div>
                        <div class="bg-discord-darker rounded-lg p-3">
                            <h4 class="text-sm text-gray-400">OS</h4>
                            <p id="os-info" class="text-lg font-semibold">-</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Command Analytics Card -->
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6 space-y-4">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-semibold text-discord-blurple">コマンド分析</h3>
                    <div class="flex space-x-2">
                        <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="changeTimeRange('day')">24時間</button>
                        <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="changeTimeRange('week')">週間</button>
                        <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="changeTimeRange('month')">月間</button>
                    </div>
                </div>
                <div class="relative h-64">
                    <canvas id="commandChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Log Viewer and Real-time Events -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- System Log Viewer -->
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-discord-blurple">システムログ</h3>
                    <div class="flex space-x-2">
                        <select id="log-level" class="bg-discord-darker text-white rounded-md px-3 py-1 text-sm">
                            <option value="all">すべて</option>
                            <option value="error">エラー</option>
                            <option value="warn">警告</option>
                            <option value="info">情報</option>
                        </select>
                        <button onclick="clearLogs()" class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors">クリア</button>
                    </div>
                </div>
                <div id="log-container" class="bg-discord-darker rounded-lg p-4 h-96 overflow-y-auto font-mono text-sm">
                    <!-- ログエントリがここに動的に追加されます -->
                </div>
            </div>

            <!-- Real-time Events -->
            <div class="card bg-discord-dark rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-semibold text-discord-blurple">リアルタイムイベント</h3>
                    <span id="event-count" class="px-2 py-1 text-sm bg-discord-blurple rounded-full">0 イベント/分</span>
                </div>
                <div id="events-container" class="space-y-2 h-96 overflow-y-auto">
                    <!-- イベントがここに動的に追加されます -->
                </div>
            </div>
        </div>

        <!-- Resource Usage Chart -->
        <div class="card bg-discord-dark rounded-xl shadow-lg p-6 space-y-4">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-semibold text-discord-blurple">リソース使用状況</h3>
                <div class="flex space-x-2">
                    <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="setChartInterval('realtime')">リアルタイム</button>
                    <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="setChartInterval('1h')">1時間</button>
                    <button class="px-3 py-1 text-sm rounded-md bg-discord-darker hover:bg-gray-600 transition-colors" onclick="setChartInterval('24h')">24時間</button>
                </div>
            </div>
            <div class="relative h-96">
                <canvas id="resourceChart"></canvas>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="bg-discord-dark py-4">
        <div class="container mx-auto px-4">
            <div class="flex justify-between items-center">
                <p class="text-gray-400">© 2024 Discord Bot Dashboard</p>
                <div class="flex space-x-4">
                    <span class="text-gray-400">Bot Version: <span id="bot-version">1.0.0</span></span>
                    <span class="text-gray-400">•</span>
                    <span class="text-gray-400">Last Updated: <span id="last-updated">-</span></span>
                </div>
            </div>
        </div>
    </footer>

    <!-- Custom JavaScript -->
    <script>
        class DashboardManager {
            constructor() {
                this.darkMode = true;
                this.charts = {};
                this.lastUpdate = null;
                this.eventCount = 0;
                this.logBuffer = [];
                this.maxLogEntries = 1000;
                this.initialize();
            }

            initialize() {
                this.initializeThemeToggle();
                this.initializeCharts();
                this.startMetricsUpdates();
                this.setupEventListeners();
                this.initializeWebSocket();
            }

            initializeThemeToggle() {
                const themeToggle = document.getElementById('theme-toggle');
                themeToggle.addEventListener('click', () => {
                    this.darkMode = !this.darkMode;
                    document.documentElement.classList.toggle('dark');
                    this.updateChartsTheme();
                });
            }

            initializeCharts() {
                this.initializeResourceChart();
                this.initializeCommandChart();
            }

            initializeResourceChart() {
                const ctx = document.getElementById('resourceChart').getContext('2d');
                const gradientCpu = ctx.createLinearGradient(0, 0, 0, 400);
                gradientCpu.addColorStop(0, 'rgba(59, 130, 246, 0.5)');
                gradientCpu.addColorStop(1, 'rgba(59, 130, 246, 0.1)');

                const gradientMemory = ctx.createLinearGradient(0, 0, 0, 400);
                gradientMemory.addColorStop(0, 'rgba(147, 51, 234, 0.5)');
                gradientMemory.addColorStop(1, 'rgba(147, 51, 234, 0.1)');

                this.charts.resource = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'CPU使用率 (%)',
                            data: [],
                            borderColor: 'rgb(59, 130, 246)',
                            backgroundColor: gradientCpu,
                            fill: true,
                            tension: 0.4
                        }, {
                            label: 'メモリ使用率 (MB)',
                            data: [],
                            borderColor: 'rgb(147, 51, 234)',
                            backgroundColor: gradientMemory,
                            fill: true,
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: this.getChartOptions()
                });
            }

            getChartOptions() {
                return {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { duration: 300 },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                            }
                        },
                        y1: {
                            beginAtZero: true,
                            position: 'right',
                            grid: {
                                drawOnChartArea: false
                            },
                            ticks: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                            }
                        },
                        x: {
                            grid: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: this.darkMode ? 'rgba(255, 255, 255, 0.7)' : 'rgba(0, 0, 0, 0.7)'
                            }
                        }
                    }
                };
            }

            updateMetrics(metrics) {
                this.lastUpdate = Date.now();
                this.updateResourceUsage(metrics);
                this.updateSystemInfo(metrics);
                this.updateStatistics(metrics);
                this.updateCommandStats(metrics.commands);
            }

            updateResourceUsage(metrics) {
                // CPU使用率の更新
                document.getElementById('cpu-usage').textContent = `${metrics.cpu}%`;
                document.getElementById('cpu-bar').style.width = `${metrics.cpu}%`;

                // メモリ使用率の更新
                const memoryUsed = metrics.memory.heapUsed;
                const memoryTotal = metrics.memory.heapTotal;
                const memoryPercentage = (memoryUsed / memoryTotal * 100).toFixed(1);
                
                document.getElementById('memory-usage').textContent = `${memoryUsed.toFixed(1)} MB`;
                document.getElementById('memory-bar').style.width = `${memoryPercentage}%`;

                // チャートの更新
                const now = new Date().toLocaleTimeString();
                this.updateResourceChart(now, metrics.cpu, memoryUsed);
            }

            updateResourceChart(label, cpu, memory) {
                const chart = this.charts.resource;
                chart.data.labels.push(label);
                chart.data.datasets[0].data.push(cpu);
                chart.data.datasets[1].data.push(memory);

                // 30データポイントまでを保持
                if (chart.data.labels.length > 30) {
                    chart.data.labels.shift();
                    chart.data.datasets[0].data.shift();
                    chart.data.datasets[1].data.shift();
                }

                chart.update('none');
            }

            updateSystemInfo(metrics) {
                document.getElementById('nodejs-version').textContent = metrics.system.nodejs;
                document.getElementById('os-info').textContent = metrics.system.platform;
                document.getElementById('bot-version').textContent = metrics.bot.version;
                
                const lastUpdated = new Date().toLocaleString();
                document.getElementById('last-updated').textContent = lastUpdated;
            }

            updateStatistics(metrics) {
                document.getElementById('total-servers').textContent = metrics.bot.guilds.toLocaleString();
                document.getElementById('total-users').textContent = metrics.bot.users.toLocaleString();
                document.getElementById('total-commands').textContent = 
                    Object.values(metrics.commands.usage).reduce((a, b) => a + b, 0).toLocaleString();

                // 稼働時間の更新
                const uptime = metrics.uptime;
                const uptimeString = `${uptime.days}d ${uptime.hours}h ${uptime.minutes}m`;
                document.getElementById('uptime').textContent = uptimeString;
            }

            addLogEntry(level, message) {
                const logContainer = document.getElementById('log-container');
                const entry = document.createElement('div');
                entry.className = `log-entry ${level} mb-1`;
                
                const timestamp = new Date().toLocaleTimeString();
                entry.innerHTML = `
                    <span class="text-gray-400">[${timestamp}]</span>
                    <span class="text-${this.getLogLevelColor(level)} font-semibold">[${level.toUpperCase()}]</span>
                    <span>${message}</span>
                `;

                logContainer.appendChild(entry);
                logContainer.scrollTop = logContainer.scrollHeight;

                // ログの制限
                this.logBuffer.push(entry);
                if (this.logBuffer.length > this.maxLogEntries) {
                    logContainer.removeChild(this.logBuffer.shift());
                }
            }

            getLogLevelColor(level) {
                const colors = {
                    error: 'discord-red',
                    warn: 'discord-yellow',
                    info: 'discord-green'
                };
                return colors[level] || 'gray-400';
            }

            showNotification(message, type = 'info') {
                const container = document.getElementById('notification-container');
                const notification = document.createElement('div');
                notification.className = `notification bg-discord-dark rounded-lg shadow-lg p-4 flex items-center space-x-3 ${type}`;
                
                const icon = this.getNotificationIcon(type);
                notification.innerHTML = `
                    ${icon}
                    <span class="flex-grow">${message}</span>
                    <button class="text-gray-400 hover:text-white" onclick="this.parentElement.remove()">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                `;

                container.appendChild(notification);
                setTimeout(() => notification.remove(), 5000);
            }

            getNotificationIcon(type) {
                const icons = {
                    info: '<svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                    success: '<svg class="w-6 h-6 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',
                    warning: '<svg class="w-6 h-6 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>',
                    error: '<svg class="w-6 h-6 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>'
                };
                return icons[type] || icons.info;
            }

            async startMetricsUpdates() {
                const updateMetrics = async () => {
                    try {
                        const response = await fetch('/metrics');
                        if (!response.ok) throw new Error('Failed to fetch metrics');
                        const data = await response.json();
                        this.updateMetrics(data);
                    } catch (error) {
                        console.error('Error fetching metrics:', error);
                        this.showNotification('メトリクスの取得に失敗しました', 'error');
                    }
                };

                // 初回更新
                await updateMetrics();
                // 定期更新（1秒ごと）
                setInterval(updateMetrics, 1000);
            }

            initializeWebSocket() {
                const ws = new WebSocket(`ws://${window.location.host}`);

                ws.onopen = () => {
                    this.addLogEntry('info', 'WebSocket接続が確立されました');
                    this.showNotification('リアルタイム更新が有効になりました', 'success');
                };

                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                ws.onclose = () => {
                    this.addLogEntry('warn', 'WebSocket接続が切断されました');
                    this.showNotification('リアルタイム更新が無効になりました', 'warning');
                    // 5秒後に再接続を試みる
                    setTimeout(() => this.initializeWebSocket(), 5000);
                };

                ws.onerror = (error) => {
                    this.addLogEntry('error', `WebSocketエラー: ${error.message}`);
                    this.showNotification('WebSocket接続エラー', 'error');
                };
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'command':
                        this.handleCommandEvent(data);
                        break;
                    case 'error':
                        this.handleErrorEvent(data);
                        break;
                    case 'system':
                        this.handleSystemEvent(data);
                        break;
                }
            }

            handleCommandEvent(data) {
                const eventsContainer = document.getElementById('events-container');
                const eventElement = document.createElement('div');
                eventElement.className = 'bg-discord-darker rounded-lg p-3 animate-fade-in';
                eventElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <span class="text-discord-blurple font-semibold">${data.command}</span>
                        <span class="text-gray-400 text-sm">${new Date(data.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="text-sm text-gray-300 mt-1">
                        実行者: ${data.user}
                    </div>
                `;

                eventsContainer.insertBefore(eventElement, eventsContainer.firstChild);
                if (eventsContainer.children.length > 100) {
                    eventsContainer.removeChild(eventsContainer.lastChild);
                }

                this.eventCount++;
                this.updateEventCount();
            }

            handleErrorEvent(data) {
                this.addLogEntry('error', data.message);
                this.showNotification(data.message, 'error');
            }

            handleSystemEvent(data) {
                this.addLogEntry('info', data.message);
                if (data.important) {
                    this.showNotification(data.message, 'info');
                }
            }

            updateEventCount() {
                const countElement = document.getElementById('event-count');
                countElement.textContent = `${this.eventCount} イベント/分`;
                // 1分ごとにカウントをリセット
                setTimeout(() => {
                    this.eventCount = 0;
                    this.updateEventCount();
                }, 60000);
            }

            setupEventListeners() {
                // ログレベルフィルター
                document.getElementById('log-level').addEventListener('change', (e) => {
                    const level = e.target.value;
                    const entries = document.querySelectorAll('.log-entry');
                    entries.forEach(entry => {
                        if (level === 'all' || entry.classList.contains(level)) {
                            entry.style.display = '';
                        } else {
                            entry.style.display = 'none';
                        }
                    });
                });

                // グラフ期間切り替え
                const timeRangeButtons = document.querySelectorAll('[onclick^="setChartInterval"]');
                timeRangeButtons.forEach(button => {
                    button.addEventListener('click', () => {
                        timeRangeButtons.forEach(b => b.classList.remove('bg-discord-blurple'));
                        button.classList.add('bg-discord-blurple');
                    });
                });
            }
        }

        // ダッシュボードの初期化
        document.addEventListener('DOMContentLoaded', () => {
            window.dashboard = new DashboardManager();
        });
    </script>
</body>
</html>